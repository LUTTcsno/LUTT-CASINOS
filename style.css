let players = JSON.parse(localStorage.getItem("players")) || {};
let user = null;
const today = new Date().toDateString();

function login() {
  const name = document.getElementById("username").value.trim();
  if (!name) return alert("Enter username");

  if (!players[name]) {
    players[name] = {
      balance: 1000,
      lastLogin: "",
      streak: 0,
      lastCase: "",
    };
  }
  user = name;
  save();
  showGame();
}

function logout() {
  user = null;
  document.getElementById("game").classList.add("hidden");
  document.getElementById("login").classList.remove("hidden");
}

function showGame() {
  document.getElementById("login").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  updateUI();
}

function updateUI() {
  const p = players[user];
  document.getElementById("balance").innerText = p.balance;
  document.getElementById("streak").innerText = p.streak;
  updateLeaderboard();
  enableButtons();
}

function save() {
  localStorage.setItem("players", JSON.stringify(players));
}

/* Enable or disable buttons based on daily limits */
function enableButtons() {
  const p = players[user];
  const todayStr = new Date().toDateString();

  document.getElementById("dailyBonusBtn").disabled = (p.lastLogin === todayStr);
  document.getElementById("caseBtn").disabled = (p.lastCase === todayStr);
}

/* üéÅ DAILY LOGIN */
function claimDaily() {
  const p = players[user];
  const todayStr = new Date().toDateString();

  if (p.lastLogin === todayStr) {
    return msg("dailyMsg", "You already claimed today!");
  }

  // Calculate streak (if yesterday logged in, +1 streak, else reset to 1)
  let yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  if (p.lastLogin === yesterday.toDateString()) {
    p.streak++;
  } else {
    p.streak = 1;
  }

  const reward = 200 + p.streak * 50;
  p.balance += reward;
  p.lastLogin = todayStr;

  save();
  updateUI();
  msg("dailyMsg", `+${reward} LUTT (Streak x${p.streak})`);
}

/* üì¶ DAILY CASE OPENING */
function openCase() {
  const p = players[user];
  const todayStr = new Date().toDateString();

  if (p.lastCase === todayStr) {
    return msg("caseResult", "You already opened your case today!");
  }

  // Show animation
  const anim = document.getElementById("caseAnimation");
  anim.classList.remove("hidden");

  // Hide animation after 2 seconds and show reward
  setTimeout(() => {
    anim.classList.add("hidden");

    // Rewards with rarity tiers
    const rewards = [
      {amount: 50, rarity: "Common"},
      {amount: 100, rarity: "Uncommon"},
      {amount: 200, rarity: "Rare"},
      {amount: 500, rarity: "Epic"},
      {amount: 1000, rarity: "Legendary"},
    ];

    // Weighted random: more chance for common
    const weights = [40, 25, 20, 10, 5];
    const reward = weightedRandom(rewards, weights);

    p.balance += reward.amount;
    p.lastCase = todayStr;

    save();
    updateUI();

    msg("caseResult", `üì¶ You won ${reward.amount} LUTT! (${reward.rarity})`);
  }, 2000);
}

/* ‚öîÔ∏è CASE BATTLE vs Bot */
function caseBattle() {
  const betInput = document.getElementById("battleBet");
  const bet = Number(betInput.value);
  const p = players[user];

  if (bet <= 0 || bet > p.balance) return alert("Invalid bet");

  // Show animation
  const anim = document.getElementById("battleAnimation");
  anim.classList.remove("hidden");

  setTimeout(() => {
    anim.classList.add("hidden");

    const youScore = Math.floor(Math.random() * 1000);
    const botScore = Math.floor(Math.random() * 1000);

    if (youScore > botScore) {
      p.balance += bet;
      msg("battleResult", `üéâ You win! (${youScore} vs ${botScore})`);
    } else {
      p.balance -= bet;
      msg("battleResult", `üòû You lose! (${youScore} vs ${botScore})`);
    }

    save();
    updateUI();
  }, 2000);
}

/* Utility: weighted random */
function weightedRandom(items, weights) {
  let total = weights.reduce((a,b) => a+b, 0);
  let rand = Math.random() * total;
  for (let i = 0; i < items.length; i++) {
    if (rand < weights[i]) return items[i];
    rand -= weights[i];
  }
  return items[items.length -1];
}

/* üèÜ LEADERBOARD */
function updateLeaderboard() {
  const list = document.getElementById("leaderboard");
  list.innerHTML = "";
  Object.entries(players)
    .sort((a,b) => b[1].balance - a[1].balance)
    .forEach(([name, data]) => {
      const li = document.createElement("li");
      li.textContent = `${name}: ${data.balance} LUTT`;
      list.appendChild(li);
    });
}

function msg(id, text) {
  document.getElementById(id).innerText = text;
}
